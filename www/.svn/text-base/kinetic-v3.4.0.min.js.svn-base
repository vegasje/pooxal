/**
 * KineticJS JavaScript Library v3.4.0
 * http://www.kineticjs.com/
 * Copyright 2011, Eric Rowell
 * Licensed under the MIT or GPL Version 2 licenses.
 * Date: Dec 31 2011
 *
 * Copyright (C) 2011 by Eric Rowell
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
var Kinetic={};Kinetic.Layer=function(a,c){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.canvas.width=a.width;this.canvas.height=a.height;this.canvas.style.position="absolute";this.shapes=[];if(c){var b=this;this.context.stroke=function(){};this.context.fill=function(){};this.context.fillRect=function(e,g,f,d){b.context.rect(e,g,f,d)};this.context.strokeRect=function(e,g,f,d){b.context.rect(e,g,f,d)};this.context.drawImage=function(){};this.context.fillText=function(){};this.context.strokeText=function(){}}a.container.appendChild(this.canvas)};Kinetic.Layer.prototype.clear=function(){var b=this.getContext();var a=this.getCanvas();b.clearRect(0,0,a.width,a.height)};Kinetic.Layer.prototype.getCanvas=function(){return this.canvas};Kinetic.Layer.prototype.getContext=function(){return this.context};Kinetic.Layer.prototype.getShapes=function(){return this.shapes};Kinetic.Layer.prototype.draw=function(){this.clear();var a=this.getContext();for(var b=0;b<this.getShapes().length;b++){this.getShapes()[b].draw(this)}};Kinetic.Stage=function(b,c,a){this.container=document.getElementById(b);this.width=c;this.height=a;this.zIndexCounter=9999;this.idCounter=0;this.dblClickWindow=400;this.mousePos=null;this.mouseDown=false;this.mouseUp=false;this.touchPos=null;this.touchStart=false;this.touchEnd=false;this.bufferLayer=new Kinetic.Layer(this);this.backstageLayer=new Kinetic.Layer(this,true);this.stageLayer=new Kinetic.Layer(this);this.propsLayer=new Kinetic.Layer(this);this.actorsLayer=new Kinetic.Layer(this);this.bufferLayer.getCanvas().style.display="none";this.backstageLayer.getCanvas().style.display="none";this.listen();this.addEventListener("mouseout",function(e){d.shapeDragging=undefined},false);var d=this;this.addEventListener("mousemove",function(f){if(d.shapeDragging){var e=d.getMousePos();d.shapeDragging.x=e.x-d.shapeDragging.offset.x;d.shapeDragging.y=e.y-d.shapeDragging.offset.y;d.drawActors()}},false);this.addEventListener("mouseup",function(e){if(d.shapeDragging){var g=d.shapeDragging.eventListeners.ondragend;if(g){for(var f=0;f<g.length;f++){g[f].func(e)}}}d.shapeDragging=undefined})};Kinetic.Stage.prototype.getBufferLayer=function(){return this.bufferLayer};Kinetic.Stage.prototype.getBackstageLayer=function(){return this.backstageLayer};Kinetic.Stage.prototype.getStageLayer=function(){return this.stageLayer};Kinetic.Stage.prototype.getPropsLayer=function(){return this.propsLayer};Kinetic.Stage.prototype.getActorsLayer=function(){return this.actorsLayer};Kinetic.Stage.prototype.clear=function(){this.stageLayer.clear()};Kinetic.Stage.prototype.clearAll=function(){this.backstageLayer.clear();this.stageLayer.clear();this.propsLayer.clear();this.actorsLayer.clear()};Kinetic.Stage.prototype.toDataURL=function(h){var b=this.getBufferLayer();var a=b.getContext();var d=this.getStageLayer();var g=this.getPropsLayer();var e=this.getActorsLayer();var f=[d,g,e];function c(k){var j=f[k].getCanvas().toDataURL();var i=new Image();i.onload=function(){a.drawImage(this,0,0);k++;if(k<f.length){c(k)}else{h(b.getCanvas().toDataURL())}};i.src=j}b.clear();c(0)};Kinetic.Stage.prototype.drawActors=function(){this.getActorsLayer().draw()};Kinetic.Stage.prototype.drawProps=function(){this.getPropsLayer().draw()};Kinetic.Stage.prototype.draw=function(){this.drawProps();this.drawActors()};Kinetic.Stage.prototype.remove=function(b){var a=this.getShapes();for(var d=0;d<a.length;d++){var c=a[d].id;if(c==b.id){b.getLayer().getShapes().splice(d,1)}}};Kinetic.Stage.prototype.removeAll=function(){this.getPropsLayer().shapes=[];this.getActorsLayer().shapes=[]};Kinetic.Stage.prototype.getCanvas=function(){return this.stageLayer.getCanvas()};Kinetic.Stage.prototype.getContext=function(){return this.stageLayer.getContext()};Kinetic.Stage.prototype.on=function(a,b){this.container.addEventListener(a,b)};Kinetic.Stage.prototype.addEventListener=function(a,b){this.on(a,b)};Kinetic.Stage.prototype.add=function(a){a.stage=this;if(a.isProp){a.layer=this.propsLayer}else{a.layer=this.actorsLayer}a.getLayer().shapes.push(a);a.id=this.idCounter++;a.draw(a.layer)};Kinetic.Stage.prototype.handleEvent=function(a){if(!a){a=window.event}this.setMousePosition(a);this.setTouchPosition(a);var f=this.backstageLayer;var c=f.getContext();var d=this;f.clear();for(var e=this.getShapes().length-1;e>=0;e--){var b=this.getShapes()[e];(function(){var g=b;g.draw(f);var k=d.touchPos||d.mousePos;var j=g.eventListeners;if(g.visible&&k!==null&&c.isPointInPath(k.x,k.y)){if(d.mouseDown){d.mouseDown=false;g.clickStart=true;if(j.onmousedown){for(var h=0;h<j.onmousedown.length;h++){j.onmousedown[h].func(a)}}e=-1}else{if(d.mouseUp){d.mouseUp=false;if(j.onmouseup){for(var h=0;h<j.onmouseup.length;h++){j.onmouseup[h].func(a)}}if(g.clickStart){if(j.onclick){for(var h=0;h<j.onclick.length;h++){j.onclick[h].func(a)}}if(j.ondblclick&&g.inDoubleClickWindow){for(var h=0;h<j.ondblclick.length;h++){j.ondblclick[h].func(a)}}g.inDoubleClickWindow=true;setTimeout(function(){g.inDoubleClickWindow=false},d.dblClickWindow)}e=-1}else{if(d.touchStart){d.touchStart=false;if(j.touchstart){for(var h=0;h<j.touchstart.length;h++){j.touchstart[h].func(a)}}e=-1}else{if(d.touchEnd){d.touchEnd=false;if(j.touchend){for(var h=0;h<j.touchend.length;h++){j.touchend[h].func(a)}}e=-1}else{if(j.touchmove){for(var h=0;h<j.touchmove.length;h++){j.touchmove[h].func(a)}e=-1}else{if(!g.mouseOver){g.mouseOver=true;if(j.onmouseover){for(var h=0;h<j.onmouseover.length;h++){j.onmouseover[h].func(a)}}e=-1}else{if(j.onmousemove){for(var h=0;h<j.onmousemove.length;h++){j.onmousemove[h].func(a)}e=-1}}}}}}}}else{if(g.mouseOver){g.mouseOver=false;if(j.onmouseout){for(var h=0;h<j.onmouseout.length;h++){j.onmouseout[h].func(a)}}e=-1}}}())}};Kinetic.Stage.prototype.listen=function(){var a=this;this.container.addEventListener("mousedown",function(b){a.mouseDown=true;a.handleEvent(b)},false);this.container.addEventListener("mousemove",function(b){a.mouseUp=false;a.mouseDown=false;a.handleEvent(b)},false);this.container.addEventListener("mouseup",function(b){a.mouseUp=true;a.mouseDown=false;a.handleEvent(b);for(var c=0;c<a.getShapes().length;c++){a.getShapes()[c].clickStart=false}},false);this.container.addEventListener("mouseover",function(b){a.handleEvent(b)},false);this.container.addEventListener("mouseout",function(b){a.mousePos=null},false);this.container.addEventListener("touchstart",function(b){b.preventDefault();a.touchStart=true;a.handleEvent(b)},false);this.container.addEventListener("touchmove",function(b){b.preventDefault();a.handleEvent(b)},false);this.container.addEventListener("touchend",function(b){b.preventDefault();a.touchEnd=true;a.handleEvent(b)},false)};Kinetic.Stage.prototype.getMousePos=function(a){return this.mousePos};Kinetic.Stage.prototype.getTouchPos=function(a){return this.touchPos};Kinetic.Stage.prototype.setMousePosition=function(a){var c=a.clientX-this.getContainerPos().left+window.pageXOffset;var b=a.clientY-this.getContainerPos().top+window.pageYOffset;this.mousePos={x:c,y:b}};Kinetic.Stage.prototype.setTouchPosition=function(c){if(c.touches!==undefined&&c.touches.length==1){var d=c.touches[0];var b=d.clientX-this.getContainerPos().left+window.pageXOffset;var a=d.clientY-this.getContainerPos().top+window.pageYOffset;this.touchPos={x:b,y:a}}};Kinetic.Stage.prototype.getContainerPos=function(){var c=this.container;var b=0;var a=0;while(c.tagName!="BODY"){b+=c.offsetTop;a+=c.offsetLeft;c=c.offsetParent}return{top:b,left:a}};Kinetic.Stage.prototype.getContainer=function(){return this.container};Kinetic.Stage.prototype.getShapes=function(){return(this.getPropsLayer().getShapes()).concat(this.getActorsLayer().getShapes())};Kinetic.Shape=function(b,a){this.drawFunc=b;this.isProp=a===undefined?false:a;this.x=0;this.y=0;this.scale={x:1,y:1};this.rotation=0;this.lastX=0;this.lastY=0;this.lastRotation=0;this.lastScale={x:1,y:1};this.eventListeners={};this.mouseOver=false;this.clickStart=false;this.inDblClickWindow=false;this.visible=true};Kinetic.Shape.prototype.getStage=function(){return this.stage};Kinetic.Shape.prototype.draw=function(c){if(this.visible){var a=this.getStage();var b=c.getContext();b.save();if(this.x!==0||this.y!==0){b.translate(this.x,this.y)}if(this.rotation!==0){b.rotate(this.rotation)}if(this.scale.x!=1||this.scale.y!=1){b.scale(this.scale.x,this.scale.y)}this.drawFunc.call(c);b.restore()}};Kinetic.Shape.prototype.draggable=function(a){if(a){var b=this;this.addEventListener("mousedown.initdrag",function(d){var e=b.getStage();e.shapeDragging=b;var c=e.getMousePos();e.shapeDragging.offset={};e.shapeDragging.offset.x=c.x-b.x;e.shapeDragging.offset.y=c.y-b.y;var g=b.eventListeners.ondragstart;if(g){for(var f=0;f<g.length;f++){g[f].func(d)}}})}else{this.removeEventListener("mousedown.initdrag")}};Kinetic.Shape.prototype.setScale=function(a){this.scale.x=a;this.scale.y=a};Kinetic.Shape.prototype.scale=function(a){this.scale.x*=a;this.scale.y*=a};Kinetic.Shape.prototype.setPosition=function(a,b){this.x=a;this.y=b};Kinetic.Shape.prototype.move=function(a,b){this.x+=a;this.y+=b};Kinetic.Shape.prototype.setRotation=function(a){this.rotation=a};Kinetic.Shape.prototype.rotate=function(a){this.rotation+=a};Kinetic.Shape.prototype.on=function(c,e){var d=(c.indexOf("touch")==-1)?"on"+c:c;var f=d.split(".");var b=f[0];var a=f.length>1?f[1]:"";if(!this.eventListeners[b]){this.eventListeners[b]=[]}this.eventListeners[b].push({name:a,func:e})};Kinetic.Shape.prototype.addEventListener=function(a,b){this.on(a,b)};Kinetic.Shape.prototype.off=function(d){var e=(d.indexOf("touch")==-1)?"on"+d:d;var f=e.split(".");var b=f[0];if(f.length>1){var a=f[1];for(var c=0;c<this.eventListeners[b].length;c++){if(this.eventListeners[b][c].name==a){this.eventListeners[b].splice(c,1);if(this.eventListeners[b].length==0){this.eventListeners[b]=undefined}break}}}else{this.eventListeners[b]=undefined}};Kinetic.Shape.prototype.removeEventListener=function(a){this.off(a)};Kinetic.Shape.prototype.show=function(){this.visible=true};Kinetic.Shape.prototype.hide=function(){this.visible=false};Kinetic.Shape.prototype.moveToTop=function(){var c=this.stage;var d=this.getLayer();var a=d.getShapes();for(var e=0;e<a.length;e++){var b=a[e];if(b.id==this.id){d.shapes.splice(e,1);d.shapes.push(this);break}}};Kinetic.Shape.prototype.getLayer=function(){return this.layer};Kinetic.Shape.prototype.makeActor=function(){var c=this.stage;var d=this.getLayer();var f=c.getPropsLayer();var e=c.getActorsLayer();var a=d.getShapes();for(var g=0;g<a.length;g++){var b=a[g];if(b.id==this.id){d.shapes.splice(g,1);e.getShapes().push(this);break}}};Kinetic.Shape.prototype.makeActor=function(){var c=this.stage;var d=this.getLayer();var f=c.getPropsLayer();var e=c.getActorsLayer();var a=d.getShapes();for(var g=0;g<a.length;g++){var b=a[g];if(b.id==this.id){d.shapes.splice(g,1);e.getShapes().push(this);this.layer=c.actorsLayer;break}}};Kinetic.Shape.prototype.makeProp=function(){var c=this.stage;var d=this.getLayer();var f=c.getPropsLayer();var e=c.getActorsLayer();var a=d.getShapes();for(var g=0;g<a.length;g++){var b=a[g];if(b.id==this.id){d.shapes.splice(g,1);f.getShapes().push(this);this.layer=c.propsLayer;break}}};Kinetic.Image=function(d){var c=d.imageObj;var h=d.x;var g=d.y;var b=d.width;var j=d.height;var f=d.isProp;if(!b){b=c.width}if(!j){j=c.height}var a=function(){var k=this.getContext();k.drawImage(c,h,g,b,j);k.beginPath();k.rect(h,g,b,j);k.closePath()};var e=new Kinetic.Shape(a,f);for(var i in e){this[i]=e[i]}};